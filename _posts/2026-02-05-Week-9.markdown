---
layout: post
title:  "Week 9"
categories: jekyll update
---

## Lighting

Improved the flickering effect on the torches by introducing a
mass-spring-damper model that simulates the intensity swinging
back to normal after a flicker 'event' occurred. This looks far
more natural than the exponential falloff we used so far.

Set the torch color to be slightly more neutral. Set the ambient
color of the scene to be a bluish gray, which is visible
in unlit areas. This gives the dungeon a colder touch and enhances
the contrast to bright areas around the torches.

<img width="300" alt="Improved flickering" src="{{site.imgpath}}/torch-flicker.gif">

By Axel Schneewind

## UI

Implemented mouse-based input for the inventory and upgrade screen.
In the inventory, items can be moved by clicking the source and slots.

Added two ui elements that show the total number of specific items.
One is added to display all items of ammunition type (i.e. arrows)
with their respective count in the inventory. A second one is added
to show all buff items in the inventory (i.e. runes) with their counts.
This way, the player can always see how many arrows they have left
without opening the inventory.

Further, switched most UI components (mainly those related to inventory
and upgrades) to event-based updating instead of polling.
This nice performance-wise as ui elements might have to do some computation
that should not be performed each frame (e.g. the new uis mentioned above
have to traverse the whole inventory to compute their numbers).

By Axel Schneewind

A damage indicator has been added to provide the player with better feedback during combat.
This indicator turns the screen border red when the player takes damage.
The intensity and fade-out time depends on the player's remaining health.

By Rene Tischler

## Balancing

Filled out missing definitions for player upgrades and removed the
perception stat as it is not really used currently and would require
changes to game logic.
I implemented the soft class system as mentioned in the presentation.

By Axel Schneewind


## Last touches on the boss door

I integrated the boss door animation and made some last adjustments.
It wasn't exactly clear if the legacy or the modern animation system would be better.
While i started with the legacy System. It was not able to make it work, or rather make it not work.
It opened immediately at the beginning of the level.
So i switch over to the modern system. While i had some problem figuring it out, i haven't used it before. I made it work.
Now we have a barricade to the boss room that only opens when the level is cleared.

## Healthbar

I tried implementing health indicators. These should consist of two parts.
The enemies should light up or have particle effects when taking damage, and all enemies should get a health bar.
Right above there heads... or whatever the slimes have.
After a discussion if we should use a bunch of canvases or one whole canvas.
I decided to simply use a plane, for everyone.
Always turning in the direction of the player. But i ran out of time before i could got it working.

By David Ruff

## Enemy Behavior

In order to bring the overlord, that we added last week, to life, we created a script that controls his behavior.
Since this enemy is our first boss in the dungeon, he should show a bit more complex behavior than our previous opponents.
The overlord only spawns in the recently added boss room by Sven Gerber.
At the beginning, he disguises himself as a statue in the room.
This statue is located relatively centrally and on the opposite side of the entrance, which is locked by the boss door.

When the player enters the room and comes within a certain distance of the boss, he comes to life.
To achieve this, materials were created that can blend between two appearances/textures.
A corresponding shader graph was created for this purpose.

The boss fight is divided into four phases.
At each phase change, the overlord roars and summons/spawns skeletons to help him fight the player.
During this time, the boss is invulnerable and takes no damage.

To make the fight more challenging, the overlord has three times as much health as normal skeletons and has a slightly increased movement speed.
The overlord chooses his attacks based on his distance to the player and the current phase.
The boss can choose between three melee attacks (grab, punch, and swiping) and two ranged attacks (jump and fire breath).

To implement the jump attack, a rigidbody is used in addition to the animation to apply short directional jump forces to the boss.
The fire breath was implemented using a particle system and a simple box collider that grows with the size of the particle system.

Furthermore, a bug in the opponent base class has been fixed, which allowed the attack coroutine to be executed multiple times.
Another bug has also been fixed, which caused slimes to continue attacking players who had already died.

By Rene Tischler

## The Boss Room

This week I implemented the Boss Room. The Idea was to create a Boss Room Prefab, which can be appended to one room of the dungeon.
But this approach made it very hard to blend the entrance of the Boss Room smoothly into any wall. So after a few thoughts, this idea
was scrapped and instead the boss room generation was implemented in the dungeon generation process.

In the dungeon definitions the variable **hasBoss** is used to check if the floor should have a Boss Room. The value of this variable is calculated depening on the progression of the player.

When a floor should have a boss room, a new room is added to the existing dungeon. The room has a fixed size and depending on the start room of the player, the boss room is placed furthest from the start room. Calculating the angle between the start room and the furthest room gives a direction where to place the boss room. With that the room is appended to a corner room of the dungeon.

These rooms are then connected via a corridor using the corridor script which is used to connect two rooms all through the dungeon generation. No furhter adjustments had to be done since the wall and pillar creation for the boss room and corridor follow the same conventions as any other room.

Since the Boss Room is quite big its lighting isn't optimal especially in the center. Four additional pillars are added inside the room and torches are placed around it, which not only fixes the lighting probleme but also gives the room a more special feeling.

But what really gives it away that this room is a boss room is the beautiful and menacingly looking Boss Door, made by David, in the middle of the boss corridor which stops the player from entering the boss room until all enemies on the floor have been defeated. Finally the boss door had also a lighting probleme which I fixed by adding toches to the corridor pillars in front of the door.

Sadly a bug appeared which lets the boss room spawn in the dungeon not at a corner. This bug appears very rarely but it's still an issue to keep an eye on. Probably the solution has something to do with the rotataion in Unity since the rotation on the Y-axis for -90° should be the same as for 270° but in the second case another flip also happening.

By Sven Gerber
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
